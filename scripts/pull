#!/bin/bash
# Pull database and/or media from remote environment
# Inspired by Lando/Platform.sh - simple developer experience
#
# Usage:
#   ./scripts/pull              # Interactive mode
#   ./scripts/pull homelab      # Pull from homelab
#   ./scripts/pull production   # Pull from production

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

cd "$PROJECT_ROOT"

DEPLOY_ENV=${1}

# Interactive environment selection if not provided
if [ -z "$DEPLOY_ENV" ]; then
    echo "╔══════════════════════════════════════╗"
    echo "║  Schmango Database Pull              ║"
    echo "╚══════════════════════════════════════╝"
    echo ""
    echo "Select environment to pull from:"
    echo "  [1] testing (default)"
    echo "  [2] production"
    echo ""
    read -p "Enter number [1]: " choice

    case ${choice:-1} in
        1) DEPLOY_ENV="testing" ;;
        2) DEPLOY_ENV="production" ;;
        *) echo "Invalid choice."; exit 1 ;;
    esac
fi

echo ""
echo "╔══════════════════════════════════════╗"
echo "║  Pulling from: ${DEPLOY_ENV}"
echo "╚══════════════════════════════════════╝"
echo ""
echo "⚠️  WARNING: This will replace your local database!"
echo ""
read -p "Continue? [y/N]: " confirm

if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo "Cancelled."
    exit 0
fi

# Check dependencies
if ! command -v ansible-playbook &> /dev/null; then
    echo ""
    echo "❌ Error: ansible-playbook not found"
    echo ""
    echo "Install with:"
    echo "  brew install ansible  # macOS"
    echo "  pip install ansible   # Linux"
    exit 1
fi

if [ ! -f "infrastructure/hosts.ini" ]; then
    echo ""
    echo "❌ Error: infrastructure/hosts.ini not found"
    exit 1
fi

# Execute the pull
echo ""
echo "→ Dumping database from ${DEPLOY_ENV}..."
ansible-playbook -i infrastructure/hosts.ini infrastructure/dump-database.yml -e "target_env=$DEPLOY_ENV" 2>&1 | grep -v "PLAY\|TASK\|ok:\|PLAY RECAP" || true

LATEST_DUMP=$(ls -t dumps/schmango_${DEPLOY_ENV}_*.sql 2>/dev/null | head -n1)

if [ -z "$LATEST_DUMP" ]; then
    echo "❌ Dump failed"
    exit 1
fi

echo "→ Restoring to local environment..."
ansible-playbook infrastructure/restore-database-local.yml -e "dump_file=$LATEST_DUMP" 2>&1 | grep -v "PLAY\|TASK\|ok:\|PLAY RECAP\|Pausing for" || true

echo ""
echo "╔══════════════════════════════════════╗"
echo "║  ✓ Pull Complete                     ║"
echo "╚══════════════════════════════════════╝"
echo ""
echo "Your local database now matches ${DEPLOY_ENV}."
echo ""
echo "Next steps:"
echo "  • Start dev: docker-compose up"
echo "  • Make model changes and create migrations"
echo "  • Test locally before deploying"
